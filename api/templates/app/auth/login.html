{% extends "app/base.html" %}
{% import "macros/auth_macros.html" as forms %}

{% block content %}
<div class="w-full max-w-[420px] px-4">
    <div id="authCard" class="card bg-[#0A0A0A]/90 border border-white/10 shadow-2xl rounded-[2rem] p-8 text-center backdrop-blur-xl">
        
        <h2 class="text-2xl font-bold text-white mb-2" id="formTitle">Welcome Back</h2>
        <p class="text-xs text-neutral-500 mb-6">Secure access via OAuth 2.0</p>
        
        <div class="grid grid-cols-2 gap-3 mb-6">
            <button onclick="oauthLogin('google')" class="flex items-center justify-center gap-2 bg-white/5 border border-white/10 rounded-xl py-3 hover:bg-white/10 transition">
                <i class="ri-google-fill text-xl text-white"></i> <span class="text-sm font-semibold text-white">Google</span>
            </button>
            <button onclick="oauthLogin('github')" class="flex items-center justify-center gap-2 bg-white/5 border border-white/10 rounded-xl py-3 hover:bg-white/10 transition">
                <i class="ri-github-fill text-xl text-white"></i> <span class="text-sm font-semibold text-white">GitHub</span>
            </button>
        </div>
        
        <div class="relative flex items-center justify-center mb-6">
            <div class="absolute inset-0 border-t border-white/10"></div>
            <span class="relative bg-[#0A0A0A] px-2 text-xs text-white/40 uppercase">Or email</span>
        </div>
        
        <form id="authForm" class="flex flex-col gap-3">
            <input type="email" id="email" placeholder="Email" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-white focus:outline-none focus:border-blue-500" required>
            <input type="password" id="password" placeholder="Password" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-white focus:outline-none focus:border-blue-500" required>
            
            <button type="submit" id="submitBtn" class="w-full bg-white text-black font-bold rounded-xl py-4 mt-2 hover:scale-[1.02] transition">Sign In</button>
        </form>
        
        <div class="mt-4 text-xs text-neutral-500">
            <button onclick="toggleMode()" id="toggleBtn" class="text-white hover:underline">Create an account</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const SB_URL = "{{ supabase_url }}";
    const SB_KEY = "{{ supabase_key }}";
    const client = supabase.createClient(SB_URL, SB_KEY);
    let isSignup = false;
    
    // --- 1. OAUTH LOGIN (SERVER SIDE FLOW) ---
    async function oauthLogin(provider) {
        // ðŸ”¥ MAGIC: Redirect to Backend Callback, NOT Frontend
        const callbackUrl = window.location.origin + "/api/auth/callback";
        
        const { error } = await client.auth.signInWithOAuth({
            provider: provider,
            options: { redirectTo: callbackUrl }
        });
        if (error) alert(error.message);
    }
    
    // --- 2. MANUAL LOGIN/SIGNUP ---
    document.getElementById('authForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.innerText = "Processing...";
        btn.disabled = true;
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const action = isSignup ? 'signup' : 'login';
        
        try {
            const res = await fetch('/api/auth/flow', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password, action })
            });
            
            const data = await res.json();
            
            if (data.error) throw new Error(data.error);
            
            // Login Success
            if (data.session) {
                // Client-side session set (Optional backup)
                await client.auth.setSession(data.session);
                window.location.href = "/" + data.next;
            } else if (data.msg) {
                alert(data.msg); // Signup email sent
                window.location.reload();
            }
            
        } catch (err) {
            alert(err.message);
            btn.innerText = isSignup ? "Sign Up" : "Sign In";
            btn.disabled = false;
        }
    });
    
    // Toggle Mode
    function toggleMode() {
        isSignup = !isSignup;
        document.getElementById('formTitle').innerText = isSignup ? "Create Account" : "Welcome Back";
        document.getElementById('submitBtn').innerText = isSignup ? "Sign Up" : "Sign In";
        document.getElementById('toggleBtn').innerText = isSignup ? "Already have an account? Sign In" : "Create an account";
    }
</script>
{% endblock %}