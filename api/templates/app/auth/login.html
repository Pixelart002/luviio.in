{% extends "app/base.html" %}
{% import "macros/auth_macros.html" as forms %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<style>
    /* ... (Copy your existing CSS here strictly) ... */
    :root { --bg: #050505; --card-bg: rgba(20, 20, 20, 0.6); --border: rgba(255,255,255,0.08); --text: #fff; --text-dim: #a1a1aa; --accent: #3b82f6; --success: #22c55e; --error: #ef4444; }
    /* ... Rest of CSS ... */
</style>
{% endblock %}

{% block content %}
<div class="grid-bg"></div>

<nav>
    <a href="/" class="brand">
        <img src="/static/images/logo.png" alt="Logo" onerror="this.style.display='none'">
        <span>LUVIIO</span>
    </a>
    <a href="mailto:contact@luviio.in" class="nav-link">Contact</a>
</nav>

<main>
    <div class="auth-card" id="authCard">
        <div class="header-text">
            <div class="title" id="formTitle">Welcome Back</div>
            <div class="subtitle" id="formSubtitle">Secure access to your dashboard</div>
        </div>

        {{ forms.social_buttons() }}

        <form id="authForm" onsubmit="handleAuth(event)">
            <input type="text" id="_hp_check" class="hp-field" tabindex="-1" autocomplete="off">
            
            {{ forms.input_field('email', 'email', 'name@company.com', 'ri-mail-line') }}
            {{ forms.input_field('password', 'password', 'Password', 'ri-lock-2-line') }}

            {{ forms.submit_button('Sign In') }}

            <div class="toggle-text">
                <span id="footerPrompt">New here?</span>
                <span class="link" onclick="toggleMode()" id="toggleLink">Create account</span>
            </div>
        </form>
    </div>
</main>

<footer>&copy; 2026 Luviio Technologies. Secure & Verified.</footer>

<div id="toast" class="toast">
    <i class="ri-information-fill"></i>
    <span id="toastMsg">Notification</span>
</div>

<script>
    // --- DYNAMIC VARIABLES ---
    const SB_URL = "{{ supabase_url }}";
    const SB_KEY = "{{ supabase_key }}";
    
    let supabaseClient = null;
    let isSignUp = false;
    let isProcessing = false;

    // --- INIT ---
    document.addEventListener("DOMContentLoaded", () => {
        if(typeof supabase !== 'undefined') supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        if(typeof gsap !== 'undefined') gsap.to("#authCard", { opacity: 1, y: 0, duration: 0.8, ease: "power3.out" });
    });

    // --- AUTH LOGIC (Strictly Preserved) ---
    async function handleAuth(e) {
        e.preventDefault();
        if (isProcessing) return;
        if (document.getElementById('_hp_check').value) return; 
        
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;

        if (password.length < 6) { showToast("Password too short", "error"); shakeCard(); return; }
        
        setLoading(true);

        try {
            if(!supabaseClient) throw new Error("Connection failed.");

            let result;
            if (isSignUp) {
                result = await supabaseClient.auth.signUp({ 
                    email, password, options: { emailRedirectTo: window.location.origin + '/onboarding' } 
                });
            } else {
                result = await supabaseClient.auth.signInWithPassword({ email, password });
            }

            if (result.error) throw result.error;

            if (isSignUp && result.data.user && !result.data.session) {
                showToast("Check email for confirmation.", "success");
                document.getElementById('authForm').reset();
            } else {
                showToast("Access Granted", "success");
                checkProfileAndRedirect(result.data.user.id);
            }
        } catch (error) {
            showToast(error.message.includes("Invalid login") ? "Incorrect credentials" : error.message, "error");
            shakeCard();
        } finally { setLoading(false); }
    }

    // --- HELPERS ---
    async function signInWithProvider(p) {
        if(!supabaseClient) return;
        const { error } = await supabaseClient.auth.signInWithOAuth({ provider: p, options: { redirectTo: window.location.origin + '/onboarding' } });
        if(error) showToast("Connection Error", "error");
    }

    function toggleMode() {
        isSignUp = !isSignUp;
        document.getElementById('formTitle').innerText = isSignUp ? "Create Account" : "Welcome Back";
        document.getElementById('formSubtitle').innerText = isSignUp ? "Start your verified journey" : "Secure access to your dashboard";
        document.getElementById('btnText').innerText = isSignUp ? "Sign Up" : "Sign In";
        document.getElementById('footerPrompt').innerText = isSignUp ? "Already a member?" : "New here?";
        document.getElementById('toggleLink').innerText = isSignUp ? "Log in" : "Create account";
        if(typeof gsap !== 'undefined') gsap.fromTo(".header-text", {opacity:0, y:-5}, {opacity:1, y:0, duration:0.3});
    }

    async function checkProfileAndRedirect(userId) {
        try {
            const { data } = await supabaseClient.from('profiles').select('role').eq('id', userId).single();
            window.location.href = (data && data.role) ? "/dashboard" : "/onboarding";
        } catch (e) { window.location.href = "/onboarding"; }
    }

    function setLoading(state) {
        isProcessing = state;
        document.getElementById('btnText').style.display = state ? 'none' : 'block';
        document.getElementById('btnLoader').style.display = state ? 'block' : 'none';
        document.getElementById('authBtn').disabled = state;
    }

    function showToast(msg, type) {
        const t = document.getElementById('toast');
        document.getElementById('toastMsg').innerText = msg;
        t.className = `toast visible ${type}`;
        t.querySelector('i').className = type === 'error' ? "ri-error-warning-fill" : "ri-checkbox-circle-fill";
        setTimeout(() => t.className = "toast", 3000);
    }

    function shakeCard() {
        if(typeof gsap !== 'undefined') gsap.to(".auth-card", { x: -6, duration: 0.08, repeat: 3, yoyo: true });
    }
</script>
{% endblock %}