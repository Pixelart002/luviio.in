{% extends "app/base.html" %}
{% import "macros/auth_macros.html" as forms %}

{% block content %}
<div class="w-full max-w-[420px] animate-fade select-none px-4">
    <div id="authCard" class="card bg-[#0A0A0A]/90 border border-white/10 shadow-2xl rounded-[2rem] overflow-hidden transition-transform">
        <div class="card-body p-8 sm:p-10 text-center">
            
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-white tracking-tight mb-1">Welcome Back</h2>
                <p class="text-xs text-neutral-500 font-medium">Secure access to your dashboard</p>
            </div>
            
            {{ forms.social_buttons() }}
            
            <form id="loginForm" class="flex flex-col gap-1 text-left">
                {{ forms.input_field('email', 'email', 'name@company.com', 'ri-mail-line') }}
                {{ forms.input_field('password', 'password', 'Password', 'ri-lock-2-line') }}
                
                {{ forms.submit_button('Sign In') }}
                
                <div class="text-center mt-6 text-xs text-neutral-500 font-medium">
                    <span>New here?</span>
                    <a href="/signup" class="text-white hover:text-blue-400 font-bold ml-1 transition-colors">Create account</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    (function() {
        // ðŸ”¥ SB_URL / SB_KEY nomenclature sync
        const SB_URL = "{{ supabase_url }}";
        const SB_KEY = "{{ supabase_key }}";

        if (!SB_URL || SB_URL === "None") {
            console.error("Supabase configuration is missing!");
            return;
        }

        const client = supabase.createClient(SB_URL, SB_KEY);
        
        const loginForm = document.getElementById('loginForm');
        const authCard = document.getElementById('authCard');
        const btn = document.getElementById('authBtn');
        const btnText = document.getElementById('btnText');
        const btnLoader = document.getElementById('btnLoader');

        const resetUI = () => {
            btn.disabled = false;
            btnText.classList.remove('invisible');
            btnLoader.classList.add('hidden');
            authCard.classList.add('animate-shake');
            setTimeout(() => authCard.classList.remove('animate-shake'), 500);
        };

        // --- ðŸ§  LOGICAL REDIRECTION HANDLER ---
        async function handleRedirection(user) {
            console.log("Validating user status...");
            
            // Step 1: Check Metadata (Super Fast)
            if (user.user_metadata && user.user_metadata.onboarded === true) {
                window.location.href = "/dashboard";
                return;
            }

            // Step 2: Fallback - Check Profiles Table (Deep Sync)
            try {
                const { data: profile } = await client.from('profiles')
                    .select('role')
                    .eq('id', user.id)
                    .single();

                if (profile && profile.role) {
                    window.location.href = "/dashboard";
                } else {
                    window.location.href = "/onboarding";
                }
            } catch (err) {
                // Default to onboarding for new/incomplete users
                window.location.href = "/onboarding";
            }
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            btn.disabled = true;
            btnText.classList.add('invisible');
            btnLoader.classList.remove('hidden');
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            try {
                const { data, error } = await client.auth.signInWithPassword({ email, password });
                if (error) throw error;

                // Start intelligent redirect
                await handleRedirection(data.user);

            } catch (error) {
                console.error("Login failed:", error.message);
                alert(error.message);
                resetUI();
            }
        });
        
        window.signInWithProvider = async (p) => {
            try {
                const { error } = await client.auth.signInWithOAuth({ 
                    provider: p, 
                    options: { 
                        redirectTo: window.location.origin + '/onboarding' 
                    } 
                });
                if (error) throw error;
            } catch (error) {
                alert("OAuth Error: " + error.message);
            }
        };
    })();
</script>

<style>
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
    }
    .animate-shake { animation: shake 0.2s ease-in-out 0s 2; }
</style>
{% endblock %}