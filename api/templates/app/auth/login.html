{% extends "app/base.html" %}
{% import "macros/auth_macros.html" as forms %}

{% block content %}
<div class="w-full max-w-[420px] animate-fade select-none px-4 relative">
    
    <script>
        // Force Non-WWW
        if (window.location.hostname.startsWith("www.")) {
            window.location.replace(window.location.href.replace("www.", ""));
        }
    </script>

    <style>
        /* Agar JS ne 'loading-active' class lagayi */
        .loading-active .card-body { display: none; }
        .loading-active .verifying-overlay { display: flex; }
        
        /* Agar URL mein Hash (#) hai (Google Return), toh default hide karo */
        :target ~ #authCard .card-body { display: none; }
        :target ~ #authCard .verifying-overlay { display: flex; }
    </style>

    <div id="access_token" class="hidden"></div>

    <div id="authCard" class="card bg-[#0A0A0A]/90 border border-white/10 shadow-2xl rounded-[2rem] overflow-hidden transition-transform min-h-[400px] flex flex-col justify-center">
        
        <div id="verifyingOverlay" class="verifying-overlay hidden absolute inset-0 bg-[#0A0A0A] z-50 flex-col items-center justify-center">
            <div class="w-12 h-12 border-4 border-white/10 border-t-blue-500 rounded-full animate-spin mb-4"></div>
            <p id="loadingText" class="text-xs font-bold text-neutral-400 tracking-widest animate-pulse">SECURING SESSION...</p>
        </div>

        <div class="card-body p-8 sm:p-10 text-center relative">
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-white tracking-tight mb-1" id="formTitle">Welcome Back</h2>
                <p class="text-xs text-neutral-500 font-medium" id="formSubtitle">Secure access to your dashboard</p>
            </div>
            
            {{ forms.social_buttons() }}
            
            <form id="authForm" class="flex flex-col gap-1 text-left">
                {{ forms.input_field('email', 'email', 'name@company.com', 'ri-mail-line') }}
                {{ forms.input_field('password', 'password', 'Password', 'ri-lock-2-line') }}
                
                {{ forms.submit_button('Sign In') }}
                
                <div class="text-center mt-6 text-xs text-neutral-500 font-medium">
                    <span id="footerPrompt">New here?</span>
                    <button type="button" onclick="toggleMode()" class="text-white hover:text-blue-400 font-bold ml-1 transition-colors" id="toggleLink">Create account</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    (function() {
        // --- CONFIGURATION ---
        const SB_URL = "{{ supabase_url }}";
        const SB_KEY = "{{ supabase_key }}"; // âš ï¸ PUBLIC ANON KEY ONLY
        const EDGE_FUNCTION_URL = "https://enqcujmzxtrbfkaungpm.supabase.co/functions/v1/signup_or_login_flow";

        // --- PRE-FLIGHT CHECK ---
        // Agar Google se wapas aaye hain (Hash exist karta hai), toh UI block kar do
        if (window.location.hash && window.location.hash.includes('access_token')) {
            document.getElementById('verifyingOverlay').classList.remove('hidden');
            document.querySelector('.card-body').style.display = 'none';
        }

        const client = supabase.createClient(SB_URL, SB_KEY);
        let isSignUp = false;

        // --- UI HELPERS ---
        const ui = {
            card: document.getElementById('authCard'),
            btn: document.getElementById('authBtn'),
            btnText: document.getElementById('btnText'),
            loader: document.getElementById('btnLoader'),
            loadingText: document.getElementById('loadingText')
        };

        function setGlobalLoading(state, text = "PROCESSING...") {
            if (state) {
                ui.card.classList.add('loading-active');
                ui.loadingText.innerText = text;
            } else {
                ui.card.classList.remove('loading-active');
            }
        }

        // ==========================================
        //  PATH 1: EMAIL/PASSWORD (via EDGE FUNCTION)
        // ==========================================
        async function callAuthEdgeFunction(email, password, action) {
            try {
                const response = await fetch(EDGE_FUNCTION_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${SB_KEY}`
                    },
                    body: JSON.stringify({ email, password, action })
                });

                const data = await response.json();

                if (!response.ok) throw new Error(data.error || "Authentication failed");

                // 1. Session Set Karo
                if (data.session) {
                    const { error } = await client.auth.setSession(data.session);
                    if (error) throw error;
                }

                // 2. Redirect based on Server Decision
                console.log(`âœ… Edge Success! Destination: ${data.next}`);
                if (data.next === 'dashboard') window.location.href = "/dashboard";
                else window.location.href = "/onboarding";

            } catch (err) {
                console.error("Auth Error:", err);
                alert(err.message);
                setGlobalLoading(false);
                ui.btn.disabled = false;
                ui.btnText.classList.remove('invisible');
                ui.loader.classList.add('hidden');
            }
        }

        // ==========================================
        //  PATH 2: GOOGLE OAUTH (via CLIENT LISTENER)
        // ==========================================
        
        // Helper to decide destination for Google Users (Since Edge function handles Email only)
        async function handleGoogleRedirect(user) {
            console.log("ðŸš¦ Google Login: Checking status...");
            
            if (user.user_metadata?.onboarded === true) {
                window.location.href = "/dashboard";
                return;
            }

            try {
                const { data: profile } = await client.from('profiles').select('role').eq('id', user.id).single();
                if (profile && profile.role) {
                    window.location.href = "/dashboard";
                } else {
                    window.location.href = "/onboarding";
                }
            } catch (err) {
                window.location.href = "/onboarding";
            }
        }

        // The "Boomerang" Catcher
        client.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN' && session) {
                // Ensure UI is blocked
                setGlobalLoading(true, "SECURING SESSION...");
                
                // URL Clean
                if (window.location.hash) {
                    window.history.replaceState(null, null, window.location.pathname);
                }

                // Check if this was a Google Login (Edge function handles email internally)
                // Hum bas safe side ke liye check run kar rahe hain
                await handleGoogleRedirect(session.user);
            }
        });

        // ==========================================
        //  EVENT HANDLERS
        // ==========================================

        const form = document.getElementById('authForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            ui.btn.disabled = true;
            ui.btnText.classList.add('invisible');
            ui.loader.classList.remove('hidden');
            setGlobalLoading(true, isSignUp ? "CREATING ACCOUNT..." : "VERIFYING CREDENTIALS...");

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const action = isSignUp ? 'signup' : 'login';

            // Email/Pass ke liye Edge Function use karein
            await callAuthEdgeFunction(email, password, action);
        });

        window.toggleMode = () => {
            isSignUp = !isSignUp;
            document.getElementById('formTitle').innerText = isSignUp ? "Create Account" : "Welcome Back";
            document.getElementById('btnText').innerText = isSignUp ? "Sign Up" : "Sign In";
            document.getElementById('footerPrompt').innerText = isSignUp ? "Already a member?" : "New here?";
            document.getElementById('toggleLink').innerText = isSignUp ? "Log in" : "Create account";
        };

        window.signInWithProvider = async (p) => {
            // Google Login -> Redirects back to THIS page
            const { error } = await client.auth.signInWithOAuth({
                provider: p,
                options: { redirectTo: window.location.href }
            });
            if (error) alert(error.message);
        };

    })();
</script>
{% endblock %}