{% extends "app/base.html" %}

{% block content %}
<section class="flex-1 flex flex-col items-center justify-center text-center px-6 py-20 md:pt-32">
    
    <div class="hero-anim opacity-0 translate-y-4 mb-6 inline-flex items-center px-3 py-1 rounded-full border border-white/10 bg-white/5">
        <span class="text-[10px] uppercase tracking-[0.2em] text-gray-400">The Trust Layer</span>
    </div>

    <h1 class="hero-anim opacity-0 translate-y-4 text-[clamp(2.5rem,10vw,5.5rem)] font-extrabold leading-none tracking-tight mb-6 text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-500">
        Infrastructure for <br class="hidden md:block" /> Verified Markets.
    </h1>

    <p class="hero-anim opacity-0 translate-y-4 text-gray-400 text-base md:text-xl max-w-lg mb-10 leading-relaxed">
        We verify, secure, and streamline <br class="md:hidden" /> marketplace infrastructure.
    </p>

    <div class="hero-anim opacity-0 translate-y-4">
        <a href="/waitlist" 
           up-target="#main-content" 
           up-transition="cross-fade"
           class="bg-white text-black font-bold px-8 py-4 rounded-full transition-transform hover:scale-105 active:scale-95 inline-flex items-center gap-2">
            Join Waitlist
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
        </a>
    </div>

    <script>
        // GSAP Animation Logic (Optimized for Unpoly)
        up.compiler('#main-content', function(element) {
            if (window.gsap) {
                // Scoped selection: animate only elements inside this new fragment
                gsap.to(element.querySelectorAll(".hero-anim"), {
                    opacity: 1,
                    y: 0,
                    duration: 0.8,
                    stagger: 0.1,
                    ease: "power2.out"
                });
            }
        });
    </script>
</section>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    (async function() {
        console.log("ðŸ”’ OAuth 2.1 Manager Loaded");
        
        // --- 1. CONFIGURATION ---
        const SB_URL = "{{ supabase_url }}";
        const SB_KEY = "{{ supabase_key }}";
        
        // Stop if keys are missing
        if (!SB_URL || SB_URL === "None") return;
        
        // --- 2. INITIALIZE SUPABASE WITH LOCAL STORAGE ---
        // We explicitly tell Supabase to use LocalStorage and persist the session
        const client = supabase.createClient(SB_URL, SB_KEY, {
            auth: {
                persistSession: true,
                storageKey: 'luviio-auth-token', // Custom key prevents conflicts
                storage: window.localStorage, // Force LocalStorage
                autoRefreshToken: true,
                detectSessionInUrl: true,
                flowType: 'pkce' // OAuth 2.1 Requirement
            }
        });
        
        // --- 3. THE "CATCHER" LOGIC ---
        // Check if we are coming back from Google (Hash # or Search ?)
        const hasHash = window.location.hash && window.location.hash.includes('access_token');
        const hasCode = window.location.search && window.location.search.includes('code=');
        
        if (hasHash || hasCode) {
            console.log("âš¡ OAuth Return Detected. Freezing UI...");
            
            // A. FREEZE UI (Immediate Feedback)
            document.body.innerHTML = `
                <div style="position:fixed;inset:0;background:#000;z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;">
                    <div style="width:50px;height:50px;border:4px solid #333;border-top:4px solid #3b82f6;border-radius:50%;animation:spin 0.6s linear infinite;margin-bottom:20px;"></div>
                    <h2 style="font-family:sans-serif;letter-spacing:1px;font-size:14px;">VERIFYING SECURE LOGIN...</h2>
                </div>
                <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>
            `;
            
            // B. PROCESS THE SESSION
            // This handles both PKCE Code exchange and Hash parsing automatically
            const { data, error } = await client.auth.getSession();
            
            if (error) {
                console.error("Auth Error:", error);
                alert("Login Failed. Please try again.");
                window.location.href = "/login";
                return;
            }
            
            if (data?.session) {
                console.log("âœ… Session Established & Saved to LocalStorage!");
                
                // C. MANUAL BACKUP (Just in case Supabase slips)
                localStorage.setItem('luviio-access-token', data.session.access_token);
                localStorage.setItem('luviio-refresh-token', data.session.refresh_token);
                
                // D. CLEAN URL
                window.history.replaceState(null, null, window.location.pathname);
                
                // E. THE "PEL DO" REDIRECT (Force Dashboard)
                // We use window.location.replace to prevent "Back" button loops
                setTimeout(() => {
                    window.location.replace("/dashboard");
                }, 500); // Small buffer to ensure storage write completes
            } else {
                // If getSession returned no session, wait for the onAuthStateChange event
                console.log("â³ Waiting for Listener event...");
            }
        }
        
        // --- 4. FALLBACK LISTENER ---
        // Sometimes the session isn't ready immediately in getSession, so we listen.
        client.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' && session) {
                console.log("âš¡ Listener Captured Session!");
                localStorage.setItem('luviio-access-token', session.access_token);
                
                if (window.location.pathname === '/' || window.location.pathname === '/login') {
                    window.location.replace("/dashboard");
                }
            }
        });
        
    })();
</script>
{% endblock %}



{% endblock %}