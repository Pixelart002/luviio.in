{% extends "app/base.html" %}

{% block content %}
<section class="flex-1 flex flex-col items-center justify-center text-center px-6 py-20 md:pt-32">
    
    <div class="hero-anim opacity-0 translate-y-4 mb-6 inline-flex items-center px-3 py-1 rounded-full border border-white/10 bg-white/5">
        <span class="text-[10px] uppercase tracking-[0.2em] text-gray-400">The Trust Layer</span>
    </div>

    <h1 class="hero-anim opacity-0 translate-y-4 text-[clamp(2.5rem,10vw,5.5rem)] font-extrabold leading-none tracking-tight mb-6 text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-500">
        Infrastructure for <br class="hidden md:block" /> Verified Markets.
    </h1>

    <p class="hero-anim opacity-0 translate-y-4 text-gray-400 text-base md:text-xl max-w-lg mb-10 leading-relaxed">
        We verify, secure, and streamline <br class="md:hidden" /> marketplace infrastructure.
    </p>

    <div class="hero-anim opacity-0 translate-y-4">
        <a href="/waitlist" 
           up-target="#main-content" 
           up-transition="cross-fade"
           class="bg-white text-black font-bold px-8 py-4 rounded-full transition-transform hover:scale-105 active:scale-95 inline-flex items-center gap-2">
            Join Waitlist
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
        </a>
    </div>

    <script>
        // GSAP Animation Logic (Optimized for Unpoly)
        up.compiler('#main-content', function(element) {
            if (window.gsap) {
                // Scoped selection: animate only elements inside this new fragment
                gsap.to(element.querySelectorAll(".hero-anim"), {
                    opacity: 1,
                    y: 0,
                    duration: 0.8,
                    stagger: 0.1,
                    ease: "power2.out"
                });
            }
        });
    </script>
</section>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    (function() {
        // --- 1. CONFIGURATION ---
        const SB_URL = "{{ supabase_url }}";
        const SB_KEY = "{{ supabase_key }}";
        
        if (!SB_URL || SB_URL === "None") return;
        
        const client = supabase.createClient(SB_URL, SB_KEY, {
            auth: {
                persistSession: true, // âœ… Ye Local Storage mein save karega
                storageKey: 'luviio-auth-token', // âœ… Custom Key taaki conflict na ho
                autoRefreshToken: true,
                detectSessionInUrl: true
            }
        });
        
        // --- 2. HASH DETECT & SAVE IMMEDIATELY ---
        if (window.location.hash && window.location.hash.includes('access_token')) {
            console.log("âš¡ Token Detected! Saving to Local Storage...");
            
            // UI FREEZE
            document.body.innerHTML = `
                <div style="position:fixed;inset:0;background:#000;z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;">
                    <div style="width:50px;height:50px;border:4px solid #333;border-top:4px solid #22c55e;border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:20px;"></div>
                    <h2 style="font-family:sans-serif;letter-spacing:1px;">SAVING SESSION...</h2>
                </div>
                <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>
            `;
            
            // --- STEP A: SESSION CAPTURE & STORAGE ---
            // Supabase automatically URL parse karke session nikal lega
            client.auth.getSession().then(async ({ data, error }) => {
                if (error) {
                    console.error("Session Error:", error);
                    window.location.href = "/login";
                    return;
                }
                
                if (data.session) {
                    console.log("âœ… Session Saved to Local Storage!");
                    
                    // Manually bhi save kar lo for safety
                    localStorage.setItem('luviio-access-token', data.session.access_token);
                    
                    // URL Clean karo taaki dobara trigger na ho
                    window.history.replaceState(null, null, window.location.pathname);
                    
                    // --- STEP B: ASK BACKEND WHERE TO GO ---
                    try {
                        const response = await fetch('/api/auth/flow', {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                action: 'oauth_check',
                                user_id: data.session.user.id,
                                user_email: data.session.user.email
                            })
                        });
                        
                        const resData = await response.json();
                        console.log("ðŸš€ Server says go to:", resData.next);
                        
                        window.location.href = "/" + (resData.next || "dashboard");
                        
                    } catch (err) {
                        console.error("Backend unresponsive, defaulting to Dashboard");
                        // Agar backend fail ho, tab bhi session LocalStorage mein hai, 
                        // toh Dashboard par user logged in hi dikhega.
                        window.location.href = "/dashboard";
                    }
                }
            });
        }
    })();
</script>



{% endblock %}