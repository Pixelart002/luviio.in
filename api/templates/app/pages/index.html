{% extends "app/base.html" %}

{% from "macros/index_page/header.html" import render_header %}
{% from "macros/index_page/drawer.html" import render_drawer %}
{% from "macros/index_page/footer.html" import render_footer %}
{% from "macros/index_page/hero.html" import render_hero %}

{% block header %}
{{ render_header() }}
{% endblock %}

{% block content %}
<style>
  /* Lenis smooth scroll base */
  html.lenis, html.lenis body { height: auto; width: 100vw; overflow-x: hidden; }
  .lenis.lenis-smooth { scroll-behavior: auto !important; }
  .lenis.lenis-smooth [data-lenis-prevent] { overscroll-behavior: contain; }
  .lenis.lenis-stopped { overflow: hidden; }
  .lenis.lenis-scrolling iframe { pointer-events: none; }
  
  /* Aceternity UI glass card utility */
  .glass-card {
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.05);
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    will-change: transform, opacity; /* hint for browser */
  }
  
  .text-glow {
    text-shadow: 0 0 40px rgba(45, 212, 191, 0.4);
  }

  /* Hero background fix – only affects the first child of main-content */
  #main-content > section:first-of-type {
    background: #fafafa !important;
  }
  #main-content > section:first-of-type * {
    color: #1e293b; /* slate-900 for text inside hero */
  }
  /* Ensure hero's own gradient still works */
  #main-content > section:first-of-type .absolute.bg-gradient-to-b {
    background: linear-gradient(to bottom, #f1f5f9, #ffffff) !important;
  }
</style>

{{ render_drawer() }}

<div id="main-content" class="w-full bg-[#050507] text-slate-200">
  {{ render_hero() }}

  <!-- GSAP Stagger Grid – step‑by‑step 3D flip -->
  <section class="relative w-full min-h-screen py-32 perspective-1000 overflow-hidden" style="perspective: 1200px;">
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-teal-900/20 rounded-full blur-[120px] pointer-events-none"></div>

    <div class="max-w-7xl mx-auto px-6 text-center mb-24 relative z-10">
      <h2 class="font-['Playfair_Display'] text-6xl md:text-8xl text-white mb-6 tracking-tight">
        The <span class="text-teal-400 text-glow font-italic">Obsidian</span> Line
      </h2>
      <p class="text-slate-400 text-xl md:text-2xl font-light max-w-2xl mx-auto">
        Brutalist geometry meets the fluidity of water. Masterpieces forged in matte black titanium.
      </p>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-3 gap-6 md:gap-8 max-w-6xl mx-auto px-6 relative z-10" id="stagger-grid">
      <!-- Cards populated by JS -->
    </div>
  </section>

  <!-- GSAP Horizontal Scroll – smooth & reliable -->
  <section id="horizontal-scroll-section" class="relative w-full h-screen bg-[#020203] overflow-hidden border-y border-white/5">
    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20 pointer-events-none"></div>
    
    <div class="sticky top-0 h-screen flex flex-col justify-center overflow-hidden">
      <div class="absolute top-16 left-6 md:left-16 z-20">
        <h3 class="font-['Playfair_Display'] text-4xl text-white">Spatial <span class="text-teal-400 italic">Harmony</span></h3>
        <p class="text-slate-500 mt-2 uppercase tracking-widest text-sm">Scroll to explore the gallery</p>
      </div>

      <div id="horizontal-track" class="flex gap-8 md:gap-12 px-6 md:px-16 pt-20 will-change-transform items-center">
        <!-- Cards inserted by JS -->
      </div>
    </div>
  </section>

  <!-- Dither Shader – optimised, only runs when visible -->
  <section id="dither-section" class="relative w-full min-h-screen py-32 overflow-hidden bg-[#050507]">
    <div class="max-w-7xl mx-auto px-6 text-center mb-16 relative z-10">
      <h2 class="font-['Playfair_Display'] text-5xl md:text-7xl text-white mb-6">
        Textural <span class="text-teal-400 font-italic">Purity</span>
      </h2>
      <p class="text-slate-400 text-lg md:text-xl font-light">
        Simulating the tactile nature of stone and water through mathematical noise.
      </p>
    </div>

    <div class="relative w-full max-w-5xl mx-auto px-6">
      <div class="relative overflow-hidden rounded-3xl p-2 glass-card">
        <div class="rounded-2xl overflow-hidden bg-black relative">
          <canvas id="dither-canvas" class="w-full h-auto aspect-[16/9] block"></canvas>
          <div class="absolute inset-0 shadow-[inset_0_0_100px_rgba(0,0,0,0.8)] pointer-events-none"></div>
        </div>
      </div>
      
      <div class="mt-10 flex flex-wrap gap-4 justify-center text-slate-300 text-sm font-medium">
        <div class="glass-card px-6 py-3 rounded-full flex gap-6 items-center">
          <label class="cursor-pointer hover:text-white transition-colors flex items-center gap-2">
            <input type="radio" name="ditherMode" value="bayer" checked class="accent-teal-400"> Bayer
          </label>
          <label class="cursor-pointer hover:text-white transition-colors flex items-center gap-2">
            <input type="radio" name="ditherMode" value="halftone" class="accent-teal-400"> Halftone
          </label>
          <label class="cursor-pointer hover:text-white transition-colors flex items-center gap-2">
            <input type="radio" name="ditherMode" value="noise" class="accent-teal-400"> Noise
          </label>
        </div>
        <div class="glass-card px-6 py-3 rounded-full flex items-center">
          <label class="cursor-pointer hover:text-white transition-colors flex items-center gap-2">
            <input type="checkbox" id="animatedCheck" checked class="accent-teal-400"> Animate Water Dynamics
          </label>
        </div>
      </div>
    </div>
  </section>
</div>

{{ render_footer() }}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/@studio-freight/lenis@1.0.33/dist/lenis.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.4/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.4/ScrollTrigger.min.js"></script>

<script>
  // ----- DRAWER TOGGLING (unchanged, but kept clean) -----
  document.addEventListener('DOMContentLoaded', function() {
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const drawer = document.getElementById('drawer');
    const overlay = document.getElementById('drawerOverlay');
    const closeBtn = document.getElementById('closeDrawerBtn');
    const drawerLinks = drawer ? drawer.querySelectorAll('a') : [];
    
    function openDrawer() {
      if (drawer) {
        drawer.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        const spans = hamburgerBtn?.querySelectorAll('span');
        if (spans && spans.length === 3) {
          spans[0].style.transform = 'rotate(45deg) translateY(9px) translateX(9px)';
          spans[1].style.opacity = '0';
          spans[2].style.transform = 'rotate(-45deg) translateY(-9px) translateX(9px)';
        }
      }
    }
    function closeDrawer() {
      if (drawer) {
        drawer.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
        document.body.style.overflow = '';
        const spans = hamburgerBtn?.querySelectorAll('span');
        if (spans && spans.length === 3) {
          spans[0].style.transform = 'none';
          spans[1].style.opacity = '1';
          spans[2].style.transform = 'none';
        }
      }
    }
    if (hamburgerBtn) hamburgerBtn.addEventListener('click', openDrawer);
    if (closeBtn) closeBtn.addEventListener('click', closeDrawer);
    if (overlay) overlay.addEventListener('click', closeDrawer);
    drawerLinks.forEach(link => link.addEventListener('click', closeDrawer));
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && drawer && !drawer.classList.contains('-translate-x-full')) closeDrawer();
    });
  });

  // ----- MAIN ANIMATIONS (optimised) -----
  (function() {
    if (typeof gsap === 'undefined' || typeof Lenis === 'undefined') return;

    gsap.registerPlugin(ScrollTrigger);

    // LENIS (smooth scroll) – minimal config
    const lenis = new Lenis({
      duration: 1.2,
      easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
      smooth: true,
      smoothTouch: false,
    });
    lenis.on('scroll', ScrollTrigger.update);
    gsap.ticker.add((time) => lenis.raf(time * 1000));
    gsap.ticker.lagSmoothing(0);

    const isMobile = window.innerWidth < 768;

    // ----- STAGGER GRID (step‑by‑step reveal) -----
    const staggerGrid = document.getElementById('stagger-grid');
    if (staggerGrid) {
      staggerGrid.innerHTML = '';
      const images = [
        'https://images.unsplash.com/photo-1584622650111-993a426fbf0a?w=800&q=90',
        'https://images.unsplash.com/photo-1620626011761-996317b8d101?w=800&q=90',
        'https://images.unsplash.com/photo-1600566753086-00f18fb6b3ea?w=800&q=90',
        'https://images.unsplash.com/photo-1552566626-52f8b828add9?w=800&q=90',
        'https://images.unsplash.com/photo-1616486338812-3dadae4b4ace?w=800&q=90',
        'https://images.unsplash.com/photo-1604014237800-1c9102c219da?w=800&q=90',
        'https://images.unsplash.com/photo-1600566753190-17f0baa2a6c3?w=800&q=90',
        'https://images.unsplash.com/photo-1585412727339-54e4bae3bbf9?w=800&q=90',
        'https://images.unsplash.com/photo-1618220179428-22790b461013?w=800&q=90'
      ];

      images.forEach((src, i) => {
        const cardContainer = document.createElement('div');
        cardContainer.style.perspective = "1500px";
        const card = document.createElement('div');
        card.className = 'stagger-card aspect-[4/5] rounded-2xl overflow-hidden relative group glass-card cursor-pointer';
        card.style.transformStyle = 'preserve-3d';
        card.style.willChange = 'transform, opacity'; // performance hint
        
        const imgBg = document.createElement('div');
        imgBg.className = 'absolute inset-0 bg-cover bg-center transition-transform duration-1000 group-hover:scale-110 opacity-70 group-hover:opacity-100';
        imgBg.style.backgroundImage = `url(${src})`;
        card.appendChild(imgBg);
        
        const overlay = document.createElement('div');
        overlay.className = 'absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent flex flex-col justify-end p-6';
        overlay.innerHTML = `
          <div class="translate-y-4 group-hover:translate-y-0 opacity-0 group-hover:opacity-100 transition-all duration-500 ease-out">
            <span class="text-teal-400 font-mono text-xs uppercase tracking-widest block mb-1">Edition 0${i + 1}</span>
            <h4 class="text-white text-xl font-['Playfair_Display']">Obsidian Masterpiece</h4>
          </div>
        `;
        card.appendChild(overlay);
        cardContainer.appendChild(card);
        staggerGrid.appendChild(cardContainer);
      });

      // Step‑by‑step stagger: each card appears sequentially
      gsap.from('.stagger-card', {
        scrollTrigger: {
          trigger: '#stagger-grid',
          start: 'top 85%',
          end: 'bottom 15%',
          scrub: 1.5,
          // invalidateOnRefresh: true ensures recalc on resize
          invalidateOnRefresh: true,
        },
        rotationY: isMobile ? 45 : (i) => (i % 3 === 0 ? 60 : i % 3 === 1 ? 0 : -60),
        rotationX: 30,
        z: -500,
        opacity: 0,
        scale: 0.8,
        stagger: 0.15, // clear step‑by‑step
        ease: "power2.out"
      });
    }

    // ----- HORIZONTAL SCROLL (bulletproof & smooth) -----
    const track = document.getElementById('horizontal-track');
    const scrollSection = document.getElementById('horizontal-scroll-section');
    if (track && scrollSection) {
      track.innerHTML = '';
      const images = [
        'https://images.unsplash.com/photo-1584622650111-993a426fbf0a?w=1000&q=90',
        'https://images.unsplash.com/photo-1620626011761-996317b8d101?w=1000&q=90',
        'https://images.unsplash.com/photo-1600566753086-00f18fb6b3ea?w=1000&q=90',
        'https://images.unsplash.com/photo-1552566626-52f8b828add9?w=1000&q=90',
        'https://images.unsplash.com/photo-1616486338812-3dadae4b4ace?w=1000&q=90',
        'https://images.unsplash.com/photo-1604014237800-1c9102c219da?w=1000&q=90'
      ];

      images.forEach((src, index) => {
        const card = document.createElement('div');
        const widthClass = isMobile ? 'w-[280px]' : 'w-[500px]';
        const heightClass = isMobile ? 'h-[400px]' : 'h-[650px]';
        card.className = `horizontal-card ${widthClass} ${heightClass} flex-shrink-0 rounded-3xl overflow-hidden relative group glass-card`;
        card.style.willChange = 'transform'; // performance
        
        const img = document.createElement('div');
        img.className = 'absolute inset-0 bg-cover bg-center transition-transform duration-[1.5s] ease-out group-hover:scale-105 filter grayscale hover:grayscale-0';
        img.style.backgroundImage = `url(${src})`;
        card.appendChild(img);

        const overlay = document.createElement('div');
        overlay.className = 'absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent';
        card.appendChild(overlay);

        const text = document.createElement('div');
        text.className = 'absolute bottom-0 left-0 p-8 w-full';
        text.innerHTML = `
          <div class="flex justify-between items-end border-b border-white/20 pb-4 mb-4 transform translate-y-4 group-hover:translate-y-0 transition-transform duration-700 ease-out">
            <span class="text-3xl md:text-5xl font-['Playfair_Display'] text-white">0${index + 1}</span>
            <span class="text-teal-400 text-sm tracking-widest uppercase">Explore</span>
          </div>
        `;
        card.appendChild(text);
        track.appendChild(card);
      });

      let scrollTriggerInstance;
      function setupHorizontalScroll() {
        if (scrollTriggerInstance) scrollTriggerInstance.kill();
        const trackWidth = track.scrollWidth;
        const viewportWidth = window.innerWidth;
        const amountToScroll = trackWidth - viewportWidth + (isMobile ? 48 : 128);
        if (amountToScroll <= 0) return;

        scrollTriggerInstance = gsap.to(track, {
          x: -amountToScroll,
          ease: 'none',
          scrollTrigger: {
            trigger: scrollSection,
            start: 'top top',
            end: `+=${amountToScroll}`,
            pin: true,
            scrub: 1.2,
            anticipatePin: 1,
            invalidateOnRefresh: true,
          }
        });
      }

      // Initial setup after images loaded
      setTimeout(setupHorizontalScroll, 150);
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(setupHorizontalScroll, 150);
      });
    }

    // ----- DITHER SHADER (fully optimised) -----
    (function initDither() {
      const canvas = document.getElementById('dither-canvas');
      if (!canvas) return;

      const config = {
        src: 'https://images.unsplash.com/photo-1527239441953-caffd968d952?q=80&w=2000&auto=format&fit=crop',
        gridSize: 3,
        ditherMode: 'bayer',
        customPalette: ['#050507', '#1A1B20', '#2DD4BF', '#F8FAFC'],
        brightness: 0.1,
        contrast: 1.2,
        backgroundColor: '#050507',
        threshold: 0.5,
        animated: true,
        animationSpeed: 0.015,
      };

      const BAYER_8x8 = [
        [0,32,8,40,2,34,10,42], [48,16,56,24,50,18,58,26],
        [12,44,4,36,14,46,6,38], [60,28,52,20,62,30,54,22],
        [3,35,11,43,1,33,9,41], [51,19,59,27,49,17,57,25],
        [15,47,7,39,13,45,5,37], [63,31,55,23,61,29,53,21]
      ];

      function parseColor(c) {
        if (c.startsWith('#')) {
          const h = c.slice(1);
          if (h.length===3) return [parseInt(h[0]+h[0],16), parseInt(h[1]+h[1],16), parseInt(h[2]+h[2],16)];
          return [parseInt(h.slice(0,2),16), parseInt(h.slice(2,4),16), parseInt(h.slice(4,6),16)];
        }
        return [0,0,0];
      }
      const custom = config.customPalette.map(parseColor);
      const clamp = (v,mi,ma) => Math.max(mi,Math.min(ma,v));
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      let img = new Image();
      img.crossOrigin = 'anonymous';
      img.src = config.src;

      let imgData = null, imgW = 0, imgH = 0, animFrame = null, time = 0;
      let isVisible = true;

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => isVisible = entry.isIntersecting);
      }, { threshold: 0 });
      observer.observe(document.getElementById('dither-section'));

      function resizeCanvas() {
        const container = canvas.parentElement;
        const rect = container.getBoundingClientRect();
        const maxWidth = 1000; // reduced for speed
        let w = rect.width;
        if (w > maxWidth) w = maxWidth;
        canvas.width = w;
        canvas.height = w * 9/16;
      }

      window.addEventListener('resize', () => { resizeCanvas(); if (imgData) renderFrame(time); });

      function renderFrame(t) {
        if (!imgData || canvas.width===0) return;
        const w = canvas.width, h = canvas.height;

        ctx.fillStyle = config.backgroundColor;
        ctx.fillRect(0,0,w,h);

        const src = imgData.data;
        const sw = imgW, sh = imgH;
        const cell = Math.max(1, config.gridSize);
        const matScale = 64;

        for (let y=0; y<h; y+=cell) {
          for (let x=0; x<w; x+=cell) {
            const waveX = config.animated ? Math.sin(y*0.05 + t*2) * 8 : 0;
            const waveY = config.animated ? Math.cos(x*0.05 + t*2) * 8 : 0;
            let sx = Math.floor(((x+waveX)/w)*sw);
            let sy = Math.floor(((y+waveY)/h)*sh);
            sx = clamp(sx,0,sw-1); sy = clamp(sy,0,sh-1);
            const idx = (sy*sw + sx)*4;
            let r = src[idx]||0, g = src[idx+1]||0, b = src[idx+2]||0, a = src[idx+3]||0;
            if (a<10) continue;

            r = clamp((r-128)*config.contrast + 128 + config.brightness*255, 0, 255);
            g = clamp((g-128)*config.contrast + 128 + config.brightness*255, 0, 255);
            b = clamp((b-128)*config.contrast + 128 + config.brightness*255, 0, 255);

            const mx = Math.floor(x/config.gridSize) % 8;
            const my = Math.floor(y/config.gridSize) % 8;
            let th = BAYER_8x8[my][mx] / matScale;
            th = th * (1-config.threshold) + config.threshold*0.5;

            const lum = (0.299*r + 0.587*g + 0.114*b)/255;
            const adj = lum + (th-0.5)*0.8;
            const cIdx = Math.floor(clamp(adj,0,0.99)*custom.length);
            ctx.fillStyle = `rgb(${custom[cIdx][0]},${custom[cIdx][1]},${custom[cIdx][2]})`;
            ctx.fillRect(x, y, cell, cell);
          }
        }
      }

      img.onload = () => {
        imgW = img.naturalWidth;
        imgH = img.naturalHeight;
        const off = document.createElement('canvas');
        off.width = imgW;
        off.height = imgH;
        const octx = off.getContext('2d');
        octx.drawImage(img, 0, 0, imgW, imgH);
        try { imgData = octx.getImageData(0,0,imgW,imgH); } catch(e) { return; }
        resizeCanvas();
        function animate() {
          if (!isVisible) { animFrame = requestAnimationFrame(animate); return; }
          if (config.animated) time += config.animationSpeed;
          renderFrame(time);
          animFrame = requestAnimationFrame(animate);
        }
        animate();
      };

      const radios = document.querySelectorAll('input[name="ditherMode"]');
      radios.forEach(r => r.addEventListener('change', e => config.ditherMode = e.target.value));
      const animChk = document.getElementById('animatedCheck');
      if (animChk) animChk.addEventListener('change', e => config.animated = e.target.checked);
    })();
  })();
</script>
{% endblock %}