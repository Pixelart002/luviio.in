{% extends "app/base.html" %}

{% from "macros/index_page/header.html" import render_header %}
{% from "macros/index_page/drawer.html" import render_drawer %}
{% from "macros/index_page/footer.html" import render_footer %}
{% from "macros/index_page/hero.html" import render_hero %}

{% block header %}
{{ render_header() }}
{% endblock %}

{% block content %}
<style>
  /* Base Lenis Smooth Scroll */
  html.lenis, html.lenis body { height: auto; width: 100vw; overflow-x: hidden; }
  .lenis.lenis-smooth { scroll-behavior: auto !important; }
  .lenis.lenis-smooth [data-lenis-prevent] { overscroll-behavior: contain; }
  .lenis.lenis-stopped { overflow: hidden; }
  .lenis.lenis-scrolling iframe { pointer-events: none; }
  
  /* Hardware Acceleration & Performance Utilities */
  .hw-accel {
    will-change: transform, opacity;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    transform: translateZ(0);
  }
  
  .glass-card {
    background: rgba(255, 255, 255, 0.02);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.05);
  }
  
  /* Optimized Canvas Rendering */
  #dither-canvas {
    image-rendering: pixelated;
    image-rendering: crisp-edges;
    width: 100%;
    height: auto;
  }
</style>

{{ render_drawer() }}

<div id="main-content" class="w-full">
  
  {{ render_hero() }}

  <div class="w-full bg-[#050507] text-slate-200 relative z-10">

    <section class="relative w-full min-h-screen py-32 perspective-1000 overflow-hidden" style="perspective: 1200px;">
      <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-teal-900/10 rounded-full blur-[120px] pointer-events-none"></div>

      <div class="max-w-7xl mx-auto px-6 text-center mb-24 relative z-10 hw-accel">
        <h2 class="font-['Playfair_Display'] text-6xl md:text-8xl text-white mb-6 tracking-tight">
          The <span class="text-teal-400 font-italic">Obsidian</span> Line
        </h2>
        <p class="text-slate-400 text-xl md:text-2xl font-light max-w-2xl mx-auto">
          Brutalist geometry meets the fluidity of water. Masterpieces forged in matte black titanium.
        </p>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-3 gap-6 md:gap-8 max-w-6xl mx-auto px-6 relative z-10" id="stagger-grid">
        </div>
    </section>

    <section id="horizontal-scroll-section" class="relative w-full h-screen bg-[#020203] overflow-hidden border-y border-white/5">
      <div class="sticky top-0 h-screen flex flex-col justify-center overflow-hidden">
        <div class="absolute top-16 left-6 md:left-16 z-20 hw-accel">
          <h3 class="font-['Playfair_Display'] text-4xl text-white">Spatial <span class="text-teal-400 italic">Harmony</span></h3>
          <p class="text-slate-500 mt-2 uppercase tracking-widest text-sm">Scroll to explore</p>
        </div>

        <div id="horizontal-track" class="flex gap-8 md:gap-12 px-6 md:px-16 pt-20 items-center hw-accel flex-nowrap w-max">
          </div>
      </div>
    </section>

    <section id="dither-section" class="relative w-full min-h-screen py-32 overflow-hidden bg-[#050507]">
      <div class="max-w-7xl mx-auto px-6 text-center mb-16 relative z-10 hw-accel">
        <h2 class="font-['Playfair_Display'] text-5xl md:text-7xl text-white mb-6">
          Textural <span class="text-teal-400 font-italic">Purity</span>
        </h2>
      </div>

      <div class="relative w-full max-w-4xl mx-auto px-6 hw-accel">
        <div class="relative overflow-hidden rounded-3xl p-1 glass-card">
          <div class="rounded-2xl overflow-hidden bg-black relative aspect-[16/9]">
            <canvas id="dither-canvas" class="block"></canvas>
            <div class="absolute inset-0 shadow-[inset_0_0_80px_rgba(0,0,0,0.9)] pointer-events-none"></div>
          </div>
        </div>
        
        <div class="mt-8 flex flex-wrap gap-4 justify-center text-slate-300 text-sm font-medium">
          <div class="glass-card px-6 py-2 rounded-full flex gap-4 items-center">
            <label class="cursor-pointer hover:text-white flex items-center gap-2"><input type="radio" name="ditherMode" value="bayer" checked> Bayer</label>
            <label class="cursor-pointer hover:text-white flex items-center gap-2"><input type="radio" name="ditherMode" value="halftone"> Halftone</label>
            <label class="cursor-pointer hover:text-white flex items-center gap-2"><input type="radio" name="ditherMode" value="noise"> Noise</label>
          </div>
          <div class="glass-card px-6 py-2 rounded-full flex items-center">
            <label class="cursor-pointer hover:text-white flex items-center gap-2"><input type="checkbox" id="animatedCheck" checked> Flow</label>
          </div>
        </div>
      </div>
    </section>

  </div> </div>

{{ render_footer() }}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/@studio-freight/lenis@1.0.33/dist/lenis.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.4/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.4/ScrollTrigger.min.js"></script>

<script>
  // Drawer Vanilla JS (unchanged, highly reliable)
  document.addEventListener('DOMContentLoaded', () => {
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const drawer = document.getElementById('drawer');
    const overlay = document.getElementById('drawerOverlay');
    const closeBtn = document.getElementById('closeDrawerBtn');
    
    const toggleDrawer = (open) => {
      if (!drawer) return;
      drawer.classList.toggle('-translate-x-full', !open);
      overlay?.classList.toggle('hidden', !open);
      document.body.style.overflow = open ? 'hidden' : '';
      
      const spans = hamburgerBtn?.querySelectorAll('span');
      if (spans && spans.length === 3) {
        spans[0].style.transform = open ? 'rotate(45deg) translateY(9px) translateX(9px)' : 'none';
        spans[1].style.opacity = open ? '0' : '1';
        spans[2].style.transform = open ? 'rotate(-45deg) translateY(-9px) translateX(9px)' : 'none';
      }
    };

    hamburgerBtn?.addEventListener('click', () => toggleDrawer(true));
    closeBtn?.addEventListener('click', () => toggleDrawer(false));
    overlay?.addEventListener('click', () => toggleDrawer(false));
  });
</script>

<script>
  (function() {
    if (typeof gsap === 'undefined' || typeof Lenis === 'undefined') return;
    gsap.registerPlugin(ScrollTrigger);

    // --- 0. LENIS INITIALIZATION (Anti-Glitch) ---
    const lenis = new Lenis({
        duration: 1.2,
        easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
        smooth: true,
        smoothTouch: false,
    });
    lenis.on('scroll', ScrollTrigger.update);
    gsap.ticker.add((time) => lenis.raf(time * 1000));
    gsap.ticker.lagSmoothing(0);

    const isMobile = window.innerWidth < 768;

    // --- 1. STAGGER GRID (3D Flip) ---
    const staggerGrid = document.getElementById('stagger-grid');
    if (staggerGrid) {
      const images = [
        'https://images.unsplash.com/photo-1584622650111-993a426fbf0a?w=800&q=90',
        'https://images.unsplash.com/photo-1620626011761-996317b8d101?w=800&q=90',
        'https://images.unsplash.com/photo-1600566753086-00f18fb6b3ea?w=800&q=90',
        'https://images.unsplash.com/photo-1552566626-52f8b828add9?w=800&q=90',
        'https://images.unsplash.com/photo-1616486338812-3dadae4b4ace?w=800&q=90',
        'https://images.unsplash.com/photo-1604014237800-1c9102c219da?w=800&q=90'
      ];

      images.forEach((src, i) => {
        const cardContainer = document.createElement('div');
        cardContainer.style.perspective = "1500px";

        const card = document.createElement('div');
        card.className = 'stagger-card hw-accel aspect-[4/5] rounded-2xl overflow-hidden relative group glass-card';
        card.style.transformStyle = 'preserve-3d';
        
        card.innerHTML = `
          <div class="absolute inset-0 bg-cover bg-center transition-transform duration-1000 group-hover:scale-110 opacity-70 group-hover:opacity-100" style="background-image: url(${src})"></div>
          <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent flex flex-col justify-end p-6">
            <span class="text-teal-400 font-mono text-xs uppercase tracking-widest block mb-1">Edition 0${i + 1}</span>
          </div>
        `;
        cardContainer.appendChild(card);
        staggerGrid.appendChild(cardContainer);
      });

      gsap.from('.stagger-card', {
        scrollTrigger: {
          trigger: '#stagger-grid',
          start: 'top 85%',
          end: 'bottom 20%',
          scrub: 1, // Smoother scrub
        },
        rotationY: isMobile ? 30 : (i) => (i % 3 === 0 ? 45 : i % 3 === 1 ? 0 : -45),
        rotationX: 20,
        z: -300,
        opacity: 0,
        scale: 0.85,
        stagger: { amount: 1, from: "center" },
        ease: "power2.out"
      });
    }

    // --- 2. ADVANCED HORIZONTAL SCROLL (Resize Safe) ---
    const track = document.getElementById('horizontal-track');
    const scrollSection = document.getElementById('horizontal-scroll-section');
    
    if (track && scrollSection) {
      const images = [
        'https://images.unsplash.com/photo-1584622650111-993a426fbf0a?w=1000&q=90',
        'https://images.unsplash.com/photo-1620626011761-996317b8d101?w=1000&q=90',
        'https://images.unsplash.com/photo-1600566753086-00f18fb6b3ea?w=1000&q=90',
        'https://images.unsplash.com/photo-1552566626-52f8b828add9?w=1000&q=90'
      ];

      images.forEach((src, index) => {
        const card = document.createElement('div');
        const widthClass = isMobile ? 'w-[80vw]' : 'w-[500px]';
        card.className = `horizontal-card hw-accel ${widthClass} h-[400px] md:h-[650px] flex-shrink-0 rounded-3xl overflow-hidden relative group glass-card`;
        
        card.innerHTML = `
          <div class="absolute inset-0 bg-cover bg-center transition-transform duration-[1.5s] ease-out group-hover:scale-105 filter grayscale group-hover:grayscale-0" style="background-image: url(${src})"></div>
          <div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent"></div>
          <div class="absolute bottom-0 left-0 p-8 w-full border-b border-white/10">
            <span class="text-3xl md:text-5xl font-['Playfair_Display'] text-white">0${index + 1}</span>
          </div>
        `;
        track.appendChild(card);
      });

      // Use matchMedia to handle screen resizes cleanly without overlapping triggers
      let mm = gsap.matchMedia();
      mm.add("(min-width: 320px)", () => {
        const amountToScroll = track.scrollWidth - window.innerWidth + (isMobile ? 48 : 128);
        
        let tween = gsap.to(track, {
          x: -amountToScroll,
          ease: 'none',
          scrollTrigger: {
            trigger: scrollSection,
            start: 'top top',
            end: () => `+=${amountToScroll}`,
            pin: true,
            scrub: 1,
            invalidateOnRefresh: true, // Crucial for anti-glitch on resize
          }
        });

        return () => tween.kill(); // Cleanup on media query change
      });
    }

    // --- 3. HIGH-PERFORMANCE DITHER SHADER ---
    (function initDither() {
      const canvas = document.getElementById('dither-canvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d', { willReadFrequently: true, alpha: false });
      
      const config = {
        src: 'https://images.unsplash.com/photo-1527239441953-caffd968d952?q=50&w=800&auto=format&fit=crop', // Low res source to save memory
        ditherMode: 'bayer',
        animated: true,
        threshold: 0.5
      };

      const BAYER_8x8 = [
        [0,32,8,40,2,34,10,42], [48,16,56,24,50,18,58,26],
        [12,44,4,36,14,46,6,38], [60,28,52,20,62,30,54,22],
        [3,35,11,43,1,33,9,41], [51,19,59,27,49,17,57,25],
        [15,47,7,39,13,45,5,37], [63,31,55,23,61,29,53,21]
      ];

      // Luviio Brand Palette (RGB format for faster array lookup)
      const palette = [
        [5, 5, 7],     // Deep Void Black
        [26, 27, 32],  // Slate
        [45, 212, 191],// Teal 400
        [248, 250, 252]// Frost White
      ];

      let img = new Image();
      img.crossOrigin = 'anonymous';
      img.src = config.src;

      let imgData = null, imgW = 0, imgH = 0, animFrame = null, time = 0;
      let isVisible = true;

      const observer = new IntersectionObserver((entries) => {
        isVisible = entries[0].isIntersecting;
      }, { threshold: 0 });
      observer.observe(document.getElementById('dither-section'));

      // Optimization: Render canvas internally small, use CSS to scale up. 
      // Massive CPU saving.
      const internalWidth = isMobile ? 250 : 400; 

      window.addEventListener('resize', () => {
        canvas.width = internalWidth;
        canvas.height = internalWidth * (9/16);
      });

      function renderFrame(t) {
        if (!imgData || canvas.width === 0) return;
        const w = canvas.width, h = canvas.height;
        
        const src = imgData.data;
        const sw = imgW, sh = imgH;
        
        // Cache current fillStyle to avoid redundant state changes
        let currentFill = '';

        for (let y = 0; y < h; y++) {
          for (let x = 0; x < w; x++) {
            const waveX = config.animated ? Math.sin(y*0.1 + t*2) * 5 : 0;
            const waveY = config.animated ? Math.cos(x*0.1 + t*2) * 5 : 0;
            
            let sx = Math.floor(((x+waveX)/w)*sw);
            let sy = Math.floor(((y+waveY)/h)*sh);
            
            sx = Math.max(0, Math.min(sx, sw-1));
            sy = Math.max(0, Math.min(sy, sh-1));

            const idx = (sy*sw + sx)*4;
            const lum = (0.299*src[idx] + 0.587*src[idx+1] + 0.114*src[idx+2])/255;

            let th;
            const mx = x % 8;
            const my = y % 8;
            
            if (config.ditherMode === 'noise') {
              th = (Math.sin(x*12.98 + y*78.23 + t*50) * 43758.54) % 1;
              if (th < 0) th += 1;
            } else if (config.ditherMode === 'halftone') {
               const rx = x*0.707 + y*0.707;
               const ry = -x*0.707 + y*0.707;
               th = (Math.sin(rx/2) + Math.sin(ry/2) + 2)/4;
            } else {
               th = BAYER_8x8[my][mx] / 64;
            }
            
            th = th * 0.5 + 0.25; // soften threshold

            const adj = lum + (th - 0.5);
            const cIdx = Math.floor(Math.max(0, Math.min(adj, 0.99)) * palette.length);
            const colorStr = `rgb(${palette[cIdx][0]},${palette[cIdx][1]},${palette[cIdx][2]})`;
            
            // Only update fillStyle if the color changes (Huge performance boost)
            if (colorStr !== currentFill) {
              ctx.fillStyle = colorStr;
              currentFill = colorStr;
            }
            ctx.fillRect(x, y, 1, 1);
          }
        }
      }

      img.onload = () => {
        imgW = img.naturalWidth;
        imgH = img.naturalHeight;
        const off = document.createElement('canvas');
        off.width = imgW;
        off.height = imgH;
        off.getContext('2d').drawImage(img, 0, 0);
        try { imgData = off.getContext('2d').getImageData(0,0,imgW,imgH); } 
        catch(e) { return; }

        canvas.width = internalWidth;
        canvas.height = internalWidth * (9/16);

        function animate() {
          if (isVisible) {
            if (config.animated) time += 0.02;
            renderFrame(time);
          }
          requestAnimationFrame(animate);
        }
        animate();
      };

      document.querySelectorAll('input[name="ditherMode"]').forEach(r => r.addEventListener('change', e => config.ditherMode = e.target.value));
      document.getElementById('animatedCheck')?.addEventListener('change', e => config.animated = e.target.checked);
    })();
  })();
</script>
{% endblock %}