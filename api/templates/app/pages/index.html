{% extends "app/base.html" %}

{% from "macros/index_page/header.html" import render_header %}
{% from "macros/index_page/drawer.html" import render_drawer %}
{% from "macros/index_page/footer.html" import render_footer %}
{% from "macros/index_page/hero.html" import render_hero %}

{% block header %}
{{ render_header() }}
{% endblock %}

{% block content %}
{{ render_drawer() }}

<div id="custom-cursor" class="fixed top-0 left-0 w-6 h-6 border border-amber-500 rounded-full pointer-events-none z-[9999] mix-blend-difference transition-transform duration-100 ease-out hidden md:block flex items-center justify-center">
  <div class="w-1 h-1 bg-amber-500 rounded-full"></div>
</div>

<div id="main-content" class="w-full bg-[#050505] text-[#e8e8e8] selection:bg-amber-600 selection:text-white">
  {{ render_hero() }}

  <section class="relative w-full min-h-screen py-32 perspective overflow-hidden border-b border-white/5">
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,rgba(197,160,89,0.05)_0%,rgba(5,5,5,1)_70%)]"></div>
    
    <div class="max-w-7xl mx-auto px-6 mb-24 relative z-10 flex flex-col md:flex-row items-end justify-between">
      <div class="max-w-2xl">
        <p class="text-amber-500 font-['Inter'] tracking-[0.2em] text-sm uppercase mb-6">The Collection</p>
        <h2 class="font-['Playfair_Display'] text-5xl md:text-8xl text-white leading-none tracking-tight stagger-title">
          Architectural<br>
          <span class="text-neutral-500 italic font-light">Fluidity.</span>
        </h2>
      </div>
      <p class="text-neutral-400 font-['Inter'] text-sm md:text-base max-w-sm mt-8 md:mt-0 text-right stagger-title">
        Discover bathware engineered with the precision of brutalist architecture and the elegance of natural water forms.
      </p>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 md:gap-4 max-w-7xl mx-auto px-6" id="stagger-grid">
      </div>
  </section>

  <section id="horizontal-scroll-section" class="relative w-full h-screen bg-[#020202] overflow-hidden border-b border-white/5">
    <div class="absolute top-12 left-6 md:left-16 z-20">
      <h2 class="font-['Playfair_Display'] text-4xl md:text-6xl text-white">The Promenade</h2>
      <p class="text-amber-500 font-['Inter'] tracking-[0.1em] text-xs uppercase mt-2">Flagship Series</p>
    </div>

    <div class="sticky top-0 h-screen flex items-center overflow-hidden">
      <div id="horizontal-track" class="flex gap-8 md:gap-16 px-6 md:px-[20vw] will-change-transform items-center">
        </div>
    </div>
  </section>

  <section id="dither-section" class="relative w-full min-h-screen bg-[#050505] py-32 overflow-hidden">
    <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-amber-600/10 blur-[120px] rounded-full pointer-events-none"></div>

    <div class="max-w-7xl mx-auto px-6 mb-16 relative z-10 flex flex-col md:flex-row items-center justify-between">
      <div>
        <h2 class="font-['Playfair_Display'] text-5xl md:text-7xl text-white mb-2">
          Material <span class="italic text-neutral-500">State</span>
        </h2>
        <p class="text-neutral-400 font-['Inter'] text-sm tracking-wide">Simulating physical textures through WebGL computation.</p>
      </div>
      
      <div class="mt-8 md:mt-0 flex flex-wrap gap-6 text-neutral-300 font-['Inter'] text-xs uppercase tracking-widest bg-white/5 p-6 rounded-none border border-white/10 backdrop-blur-md">
        <label class="cursor-pointer hover:text-amber-500 transition-colors flex items-center gap-2">
          <input type="radio" name="ditherMode" value="bayer" checked class="accent-amber-500"> Ceramic Grid
        </label>
        <label class="cursor-pointer hover:text-amber-500 transition-colors flex items-center gap-2">
          <input type="radio" name="ditherMode" value="noise"> Steam Noise
        </label>
        <label class="cursor-pointer hover:text-amber-500 transition-colors flex items-center gap-2">
          <input type="radio" name="ditherMode" value="crosshatch"> Brushed Brass
        </label>
        <div class="w-px h-4 bg-white/20 mx-2 hidden md:block"></div>
        <label class="cursor-pointer text-amber-500 flex items-center gap-2">
          <input type="checkbox" id="animatedCheck" checked class="accent-amber-500"> Fluid Dynamics
        </label>
      </div>
    </div>

    <div class="relative w-full max-w-7xl mx-auto px-6 z-10">
      <div class="relative overflow-hidden border border-white/10 bg-[#0a0a0a] group cursor-none">
        <canvas id="dither-canvas" class="w-full h-auto aspect-[16/7] md:aspect-[21/9] object-cover transition-transform duration-700 group-hover:scale-105"></canvas>
        <div class="absolute inset-0 bg-gradient-to-t from-[#050505] via-transparent to-transparent opacity-80 pointer-events-none"></div>
      </div>
    </div>
  </section>
</div>

{{ render_footer() }}
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
<script src="https://unpkg.com/@studio-freight/lenis@1.0.34/dist/lenis.min.js"></script>

<script>
  // 1. Initialize Smooth Scrolling (Lenis)
  const lenis = new Lenis({
    duration: 1.2,
    easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
    direction: 'vertical',
    gestureDirection: 'vertical',
    smooth: true,
    mouseMultiplier: 1,
    smoothTouch: false,
    touchMultiplier: 2,
    infinite: false,
  });

  function raf(time) {
    lenis.raf(time);
    requestAnimationFrame(raf);
  }
  requestAnimationFrame(raf);

  // Sync GSAP with Lenis
  gsap.registerPlugin(ScrollTrigger);
  lenis.on('scroll', ScrollTrigger.update);
  gsap.ticker.add((time)=>{
    lenis.raf(time * 1000);
  });
  gsap.ticker.lagSmoothing(0);

  // 2. Custom Cursor Logic
  const cursor = document.getElementById('custom-cursor');
  if (window.matchMedia("(pointer: fine)").matches) {
    let mouseX = 0, mouseY = 0, cursorX = 0, cursorY = 0;
    
    document.addEventListener('mousemove', (e) => {
      mouseX = e.clientX;
      mouseY = e.clientY;
    });

    gsap.ticker.add(() => {
      cursorX += (mouseX - cursorX) * 0.15;
      cursorY += (mouseY - cursorY) * 0.15;
      gsap.set(cursor, { x: cursorX - 12, y: cursorY - 12 });
    });

    // Cursor hover effects
    const interactiveElements = document.querySelectorAll('a, button, input, label, .horizontal-card, canvas');
    interactiveElements.forEach(el => {
      el.addEventListener('mouseenter', () => gsap.to(cursor, { scale: 2.5, backgroundColor: 'rgba(245, 158, 11, 0.1)', duration: 0.3 }));
      el.addEventListener('mouseleave', () => gsap.to(cursor, { scale: 1, backgroundColor: 'transparent', duration: 0.3 }));
    });
  }

  // 3. Drawer Navigation Logic
  document.addEventListener('DOMContentLoaded', function() {
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const drawer = document.getElementById('drawer');
    const overlay = document.getElementById('drawerOverlay');
    const closeBtn = document.getElementById('closeDrawerBtn');
    const drawerLinks = drawer ? drawer.querySelectorAll('a') : [];
    
    function openDrawer() {
      if (drawer) {
        drawer.classList.remove('-translate-x-full');
        if(overlay) overlay.classList.remove('hidden');
        lenis.stop(); // Pause smooth scrolling
        
        const spans = hamburgerBtn?.querySelectorAll('span');
        if (spans && spans.length === 3) {
          gsap.to(spans[0], {y: 9, rotation: 45, duration: 0.4, ease: "power2.inOut"});
          gsap.to(spans[1], {opacity: 0, duration: 0.2});
          gsap.to(spans[2], {y: -9, rotation: -45, duration: 0.4, ease: "power2.inOut"});
        }
      }
    }
    
    function closeDrawer() {
      if (drawer) {
        drawer.classList.add('-translate-x-full');
        if(overlay) overlay.classList.add('hidden');
        lenis.start(); // Resume scrolling
        
        const spans = hamburgerBtn?.querySelectorAll('span');
        if (spans && spans.length === 3) {
          gsap.to(spans[0], {y: 0, rotation: 0, duration: 0.4, ease: "power2.inOut"});
          gsap.to(spans[1], {opacity: 1, duration: 0.4});
          gsap.to(spans[2], {y: 0, rotation: 0, duration: 0.4, ease: "power2.inOut"});
        }
      }
    }
    
    if (hamburgerBtn) hamburgerBtn.addEventListener('click', openDrawer);
    if (closeBtn) closeBtn.addEventListener('click', closeDrawer);
    if (overlay) overlay.addEventListener('click', closeDrawer);
    drawerLinks.forEach(link => link.addEventListener('click', closeDrawer));
  });
</script>

<script>
  (function() {
    const isMobile = window.innerWidth < 768;

    // --- Title Reveal Animation ---
    gsap.from(".stagger-title", {
      scrollTrigger: {
        trigger: ".stagger-title",
        start: "top 85%",
      },
      y: 50,
      opacity: 0,
      duration: 1.2,
      stagger: 0.2,
      ease: "power4.out"
    });

    // --- 1. GSAP STAGGER GRID (3D Matrix) ---
    const staggerGrid = document.getElementById('stagger-grid');
    if (staggerGrid) {
      // Premium dark aesthetic imagery
      const images = [
        'https://images.unsplash.com/photo-1620626011761-996317b8d101?w=800&q=90',
        'https://images.unsplash.com/photo-1584622650111-993a426fbf0a?w=800&q=90',
        'https://images.unsplash.com/photo-1600566752355-35792bedcfea?w=800&q=90',
        'https://images.unsplash.com/photo-1507652313519-d4e9174296fc?w=800&q=90',
        'https://images.unsplash.com/photo-1552566626-52f8b828add9?w=800&q=90',
        'https://images.unsplash.com/photo-1604014237800-1c9102c219da?w=800&q=90',
        'https://images.unsplash.com/photo-1620626011761-996317b8d101?w=800&q=90',
        'https://images.unsplash.com/photo-1584622650111-993a426fbf0a?w=800&q=90',
        'https://images.unsplash.com/photo-1600566752355-35792bedcfea?w=800&q=90'
      ];

      images.forEach((src, i) => {
        const card = document.createElement('div');
        card.className = 'stagger-card aspect-[4/5] overflow-hidden relative group bg-[#111]';
        card.style.transformStyle = 'preserve-3d';
        
        const img = document.createElement('div');
        img.className = 'absolute inset-0 transition-transform duration-1000 group-hover:scale-110';
        img.style.background = `url(${src}) center/cover`;
        img.style.filter = 'grayscale(80%) contrast(1.2)';
        card.appendChild(img);
        
        const overlay = document.createElement('div');
        overlay.className = 'absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500 flex flex-col justify-end p-6 border border-white/0 group-hover:border-white/10';
        overlay.innerHTML = `
          <span class="text-amber-500 font-['Inter'] text-xs tracking-widest uppercase mb-1">Series 0${i + 1}</span>
          <span class="text-white font-['Playfair_Display'] text-2xl">Matte Stone</span>
        `;
        card.appendChild(overlay);
        
        staggerGrid.appendChild(card);
      });

      gsap.from('.stagger-card', {
        scrollTrigger: {
          trigger: '#stagger-grid',
          start: 'top 75%',
          end: 'bottom 25%',
          scrub: isMobile ? 1 : 1.5,
        },
        y: 100,
        z: -300,
        rotationX: 20,
        rotationY: (i) => (i % 3 === 0 ? 15 : i % 3 === 1 ? 0 : -15),
        opacity: 0,
        stagger: {
          amount: 1.2,
          from: "center",
          grid: isMobile ? [2, 4] : [3, 3],
          ease: "power2.inOut"
        },
        ease: "power3.out"
      });
    }

    // --- 2. GSAP HORIZONTAL SCROLL (Inertia Skewing) ---
    const track = document.getElementById('horizontal-track');
    if (track) {
      const horizontalImages = [
        'https://images.unsplash.com/photo-1595515106969-1ce29566ff1c?w=900&q=90',
        'https://images.unsplash.com/photo-1600566753086-00f18fb6b3ea?w=900&q=90',
        'https://images.unsplash.com/photo-1618220179428-22790b461013?w=900&q=90',
        'https://images.unsplash.com/photo-1616486338812-3dadae4b4ace?w=900&q=90',
        'https://images.unsplash.com/photo-1604014237800-1c9102c219da?w=900&q=90',
      ];

      horizontalImages.forEach((src, index) => {
        const card = document.createElement('div');
        const widthClass = isMobile ? 'w-[280px]' : 'w-[500px]';
        const heightClass = isMobile ? 'h-[400px]' : 'h-[700px]';
        card.className = `horizontal-card ${widthClass} ${heightClass} flex-shrink-0 overflow-hidden relative group`;
        
        const imgInner = document.createElement('div');
        imgInner.className = 'w-full h-full bg-center bg-cover transition-transform duration-[1.5s] ease-[cubic-bezier(0.19,1,0.22,1)] group-hover:scale-105';
        imgInner.style.backgroundImage = `url(${src})`;
        imgInner.style.filter = 'grayscale(30%)';
        card.appendChild(imgInner);

        const overlay = document.createElement('div');
        overlay.className = 'absolute inset-0 bg-black/40 group-hover:bg-transparent transition-colors duration-700';
        card.appendChild(overlay);

        const text = document.createElement('div');
        text.className = 'absolute bottom-8 left-8 text-white overflow-hidden';
        text.innerHTML = `
          <div class="translate-y-[120%] group-hover:translate-y-0 transition-transform duration-700 ease-[cubic-bezier(0.19,1,0.22,1)] font-['Playfair_Display'] text-3xl md:text-4xl">Freestanding</div>
          <div class="translate-y-[120%] group-hover:translate-y-0 transition-transform duration-700 delay-75 ease-[cubic-bezier(0.19,1,0.22,1)] font-['Inter'] text-sm tracking-widest text-amber-500 mt-2 uppercase">View Detail</div>
        `;
        card.appendChild(text);

        track.appendChild(card);
      });

      setTimeout(() => {
        const trackWidth = track.scrollWidth;
        const viewportWidth = window.innerWidth;
        const maxScroll = trackWidth - viewportWidth;

        if (maxScroll <= 0) return;

        // The Scroll Animation
        let scrollTween = gsap.to(track, {
          x: -maxScroll,
          ease: 'none',
          scrollTrigger: {
            trigger: '#horizontal-scroll-section',
            start: 'top top',
            end: () => `+=${maxScroll * 1.5}`, // Extend scroll duration for smoothness
            pin: true,
            scrub: 1, // Smooth scrubbing
            invalidateOnRefresh: true,
          }
        });

        // Advanced: Inertia Skew Effect during horizontal scroll
        let proxy = { skew: 0 }, skewSetter = gsap.quickSetter(".horizontal-card", "skewX", "deg"), clamp = gsap.utils.clamp(-15, 15);
        ScrollTrigger.create({
          onUpdate: (self) => {
            let skew = clamp(self.getVelocity() / -300);
            if (Math.abs(skew) > Math.abs(proxy.skew)) {
              proxy.skew = skew;
              gsap.to(proxy, {skew: 0, duration: 0.8, ease: "power3", overwrite: true, onUpdate: () => skewSetter(proxy.skew)});
            }
          }
        });
      }, 500);
    }
  })();
</script>

<script>
  (function initDither() {
    const canvas = document.getElementById('dither-canvas');
    if (!canvas) return;

    // Premium dark mode configuration
    const config = {
      src: 'https://images.unsplash.com/photo-1507652313519-d4e9174296fc?q=80&w=2000&auto=format&fit=crop', // Water ripples / dark texture
      gridSize: 3,
      ditherMode: 'bayer',
      colorMode: 'custom',
      invert: false,
      pixelRatio: window.devicePixelRatio || 1,
      customPalette: ['#050505', '#1a1a1a', '#C5A059', '#e8e8e8'], // Obsidian to Brass to Alabaster
      brightness: -0.1,
      contrast: 1.3,
      threshold: 0.5,
      animated: true,
      animationSpeed: 0.015,
    };

    const BAYER_8x8 = [
      [0,32,8,40,2,34,10,42],
      [48,16,56,24,50,18,58,26],
      [12,44,4,36,14,46,6,38],
      [60,28,52,20,62,30,54,22],
      [3,35,11,43,1,33,9,41],
      [51,19,59,27,49,17,57,25],
      [15,47,7,39,13,45,5,37],
      [63,31,55,23,61,29,53,21]
    ];

    function parseColor(c) {
      if (c.startsWith('#')) {
        const h = c.slice(1);
        if (h.length===3) return [parseInt(h[0]+h[0],16), parseInt(h[1]+h[1],16), parseInt(h[2]+h[2],16)];
        return [parseInt(h.slice(0,2),16), parseInt(h.slice(2,4),16), parseInt(h.slice(4,6),16)];
      }
      return [0,0,0];
    }
    
    const custom = config.customPalette.map(parseColor);
    function luminance(r,g,b) { return 0.299*r + 0.587*g + 0.114*b; }
    function clamp(v,mi,ma) { return Math.max(mi,Math.min(ma,v)); }

    const ctx = canvas.getContext('2d', { alpha: false });
    let img = new Image();
    img.crossOrigin = 'anonymous';
    img.src = config.src;

    let imgData = null, imgW = 0, imgH = 0, animFrame = null, time = 0, isVisible = false;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => isVisible = entry.isIntersecting);
    }, { threshold: 0.05 });
    observer.observe(document.getElementById('dither-section'));

    function resizeCanvas() {
      const container = canvas.parentElement;
      const rect = container.getBoundingClientRect();
      const maxWidth = 1200; 
      let w = rect.width;
      if (w > maxWidth) w = maxWidth;
      canvas.width = w;
      canvas.height = w * (window.innerWidth < 768 ? 7/16 : 9/21); // match aspect ratio classes
    }

    window.addEventListener('resize', () => {
      resizeCanvas();
      if (imgData) renderFrame(time);
    });

    function renderFrame(t) {
      if (!imgData || canvas.width===0) return;
      const w = canvas.width, h = canvas.height;
      const src = imgData.data;
      const sw = imgW, sh = imgH;
      const cell = Math.max(1, Math.floor(config.gridSize));

      ctx.fillStyle = '#050505';
      ctx.fillRect(0,0,w,h);

      for (let y=0; y<h; y+=cell) {
        for (let x=0; x<w; x+=cell) {
          const sx = Math.floor((x/w)*sw);
          const sy = Math.floor((y/h)*sh);
          const idx = (sy*sw + sx)*4;

          let r = src[idx], g = src[idx+1], b = src[idx+2];
          
          r = clamp((r-128)*config.contrast + 128 + config.brightness*255, 0, 255);
          g = clamp((g-128)*config.contrast + 128 + config.brightness*255, 0, 255);
          b = clamp((b-128)*config.contrast + 128 + config.brightness*255, 0, 255);

          const lum = luminance(r,g,b)/255;
          let th;
          const mx = Math.floor(x/config.gridSize) % 8;
          const my = Math.floor(y/config.gridSize) % 8;

          switch (config.ditherMode) {
            case 'noise':
              const n = Math.sin(x*12.9898 + y*78.233 + t*50) * 43758.5453;
              th = n - Math.floor(n);
              break;
            case 'crosshatch':
              const l1 = (x+y) % (config.gridSize*3) < config.gridSize ? 1 : 0;
              const l2 = (x-y+100) % (config.gridSize*3) < config.gridSize ? 1 : 0;
              th = (l1+l2)/2;
              break;
            case 'bayer':
            default:
              th = BAYER_8x8[my][mx] / 64;
          }

          th = th * (1-config.threshold) + config.threshold*0.5;

          // Multi-color palette mapping
          const adj = lum + (th-0.5)*0.6;
          const pIdx = Math.floor(clamp(adj, 0, 0.99) * custom.length);
          const cOut = custom[pIdx];

          ctx.fillStyle = `rgb(${cOut[0]},${cOut[1]},${cOut[2]})`;
          ctx.fillRect(x, y, cell, cell);
        }
      }
    }

    img.onload = () => {
      imgW = img.naturalWidth;
      imgH = img.naturalHeight;
      const off = document.createElement('canvas');
      off.width = imgW; off.height = imgH;
      const octx = off.getContext('2d');
      octx.drawImage(img, 0, 0, imgW, imgH);
      imgData = octx.getImageData(0,0,imgW,imgH);
      
      resizeCanvas();
      
      function animate() {
        if (isVisible) {
          if (config.animated) time += config.animationSpeed;
          renderFrame(time);
        }
        animFrame = requestAnimationFrame(animate);
      }
      animate();
    };

    // Controls
    const radios = document.querySelectorAll('input[name="ditherMode"]');
    radios.forEach(r => r.addEventListener('change', e => config.ditherMode = e.target.value));
    const animChk = document.getElementById('animatedCheck');
    if (animChk) animChk.addEventListener('change', e => config.animated = e.target.checked);
  })();
</script>
{% endblock %}