{% extends "app/base.html" %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
    /* --- SCOPED STYLES: LUVIIO DARK THEME --- */
    .waitlist-wrapper {
        font-family: 'Inter', sans-serif;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        width: 100%;
        /* FIXED: Use dvh for better mobile browser support */
        min-height: 100dvh; 
        /* FIXED: Add padding to prevent edge touching on mobile */
        padding: 20px;
        box-sizing: border-box;
        
        --text-dim: #a1a1aa;
        --accent: #3b82f6;
        --accent-glow: rgba(59, 130, 246, 0.4);
        --error: #ef4444;
        --success: #22c55e;
        --ease-elastic: cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* Floating Pill UI */
    .pill { 
        border: 1px solid rgba(255,255,255,0.08); 
        background: rgba(255,255,255,0.02); 
        padding: 6px 16px; 
        border-radius: 100px; 
        font-size: 0.75rem; 
        color: var(--text-dim); 
        margin-bottom: 24px; 
        display: inline-block; 
        backdrop-filter: blur(10px);
        letter-spacing: 0.05em;
        text-transform: uppercase;
    }
    
    /* Hero Typography */
    .hero-title { 
        /* Responsive Font Size */
        font-size: clamp(2.2rem, 8vw, 5rem); 
        font-weight: 800; 
        margin-bottom: 20px; 
        line-height: 1.1; 
        letter-spacing: -0.04em;
        background: linear-gradient(180deg, #fff 10%, #888 100%); 
        -webkit-background-clip: text; 
        -webkit-text-fill-color: transparent; 
        /* Prevent gradient clipping on resize */
        padding-bottom: 0.1em;
    }
    
    .hero-desc { 
        font-size: clamp(0.95rem, 4vw, 1.2rem); 
        color: var(--text-dim); 
        max-width: 550px; 
        line-height: 1.6; 
        margin-bottom: 40px; 
    }

    /* Form UI: Glassmorphism */
    .form-container { 
        width: 100%; 
        max-width: 440px; 
    }
    
    .input-wrapper { 
        background: rgba(20, 20, 20, 0.6); 
        border: 1px solid rgba(255,255,255,0.08); 
        border-radius: 100px; /* Fully rounded looks better on mobile */
        padding: 6px; 
        display: flex; 
        gap: 8px; /* Slightly reduced gap */
        transition: all 0.4s var(--ease-elastic); 
        backdrop-filter: blur(20px);
    }
    
    .input-wrapper:focus-within { 
        border-color: var(--accent); 
        box-shadow: 0 0 40px var(--accent-glow); 
        transform: translateY(-2px);
    }
    
    .custom-input { 
        flex: 1; 
        background: transparent; 
        border: none; 
        outline: none; 
        padding: 12px 16px; 
        color: white; 
        font-size: 1rem;
        font-family: inherit;
        /* Fix for iOS input zoom and sizing */
        min-width: 0; 
    }

    /* Button Styling */
    .submit-btn { 
        background: white; 
        color: black; 
        border: none; 
        border-radius: 100px; 
        padding: 0 24px; 
        height: 52px; 
        font-weight: 700; 
        cursor: pointer; 
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        font-size: 1rem;
    }
    .submit-btn:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 10px 20px rgba(255,255,255,0.1); }
    .submit-btn:disabled { opacity: 0.8; cursor: not-allowed; }

    /* --- RESPONSIVE ADJUSTMENTS FOR MOBILE --- */
    @media (max-width: 480px) {
        .submit-btn {
            padding: 0 16px;
            font-size: 0.9rem; /* Slightly smaller text to fit input */
        }
        .input-wrapper {
            padding: 4px; /* Tighter padding on mobile */
        }
        .custom-input {
            padding: 12px;
            font-size: 16px; /* Prevents iOS auto-zoom */
        }
    }

    /* Custom Toast */
    .toast {
        position: fixed; 
        bottom: 40px; 
        left: 50%; 
        transform: translateX(-50%) translateY(30px);
        background: rgba(10, 10, 10, 0.98); 
        border: 1px solid rgba(255,255,255,0.1);
        padding: 14px 28px; 
        border-radius: 100px; 
        color: #fff; 
        z-index: 999; 
        opacity: 0; 
        transition: all 0.5s var(--ease-elastic);
        backdrop-filter: blur(20px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        width: max-content;
        max-width: 90%; /* Prevent overflow on small screens */
        text-align: center;
    }
    .toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* Loading Spinner */
    .spinner { 
        width: 20px; 
        height: 20px; 
        border: 2.5px solid rgba(0,0,0,0.1); 
        border-left-color: #000; 
        border-radius: 50%; 
        animation: spin 0.8s linear infinite; 
        display: none; 
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- ANIMATION FIX: Force Opacity 1 by default --- */
    .fade-in { 
        opacity: 1; 
        transform: none; 
    }
</style>

<div class="waitlist-wrapper">
    <div class="hero-content">
        <div class="pill fade-in">Early Access â€¢ 2026</div>
        
        <h1 class="hero-title fade-in">The Operating System <br> for Listings.</h1>
        
        <p class="hero-desc fade-in">
            We are rebuilding marketplace infrastructure from the ground up. 
            Join the verified, API-first future.
        </p>

        <div class="form-container fade-in mx-auto">
            <form id="waitlistForm" novalidate>
                <div class="input-wrapper">
                    <input type="email" id="email" class="custom-input" 
                           placeholder="Enter your email" required autocomplete="off">
                    
                    <button type="submit" id="submitBtn" class="submit-btn">
                        <span class="btn-text">Join Waitlist</span>
                        <div class="spinner" id="btnLoader"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="toast">
        <span id="toastMsg">Success! You're on the list.</span>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const wrapper = document.querySelector('.waitlist-wrapper');
        
        // Safety Check
        if (!wrapper) return;

        // --- ANIMATIONS (Optional enhancement) ---
        // If GSAP exists, we animate. If not, CSS defaults to visible.
        if (window.gsap) {
            gsap.fromTo(wrapper.querySelectorAll(".fade-in"), 
                { opacity: 0, y: 20 },
                { opacity: 1, y: 0, duration: 1, stagger: 0.15, ease: "power4.out" }
            );
        }

        // --- LOGIC ---
        const ui = {
            form: wrapper.querySelector('#waitlistForm'),
            email: wrapper.querySelector('#email'),
            btn: wrapper.querySelector('#submitBtn'),
            btnText: wrapper.querySelector('.btn-text'),
            loader: wrapper.querySelector('#btnLoader'),
            toast: wrapper.querySelector('#toast'),
            toastMsg: wrapper.querySelector('#toastMsg')
        };

        const showToast = (msg, isError = false) => {
            ui.toastMsg.innerText = msg;
            ui.toast.style.borderColor = isError ? '#ef4444' : 'rgba(255,255,255,0.1)';
            ui.toast.classList.add('visible');
            setTimeout(() => ui.toast.classList.remove('visible'), 4000);
        };

        const setSubmitting = (state) => {
            ui.btn.disabled = state;
            ui.btnText.style.display = state ? 'none' : 'block';
            ui.loader.style.display = state ? 'block' : 'none';
        };

        if (ui.form) {
            ui.form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = ui.email.value.trim();
                
                if (!email || !email.includes('@')) {
                    showToast("Please enter a valid email address.", true);
                    return;
                }

                setSubmitting(true);

                try {
                    // âœ… SECURE WAY: Call Backend API instead of Supabase Direct
                    const response = await fetch('/waitlist', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || "Failed to join");
                    }

                    // --- SUCCESS UI ---
                    showToast(result.message || "Welcome to the list! ðŸš€");
                    ui.email.value = "";
                    ui.email.disabled = true;
                    ui.btn.style.backgroundColor = "#22c55e"; // Success Green
                    ui.btn.style.color = "#fff";
                    ui.btnText.innerText = "Joined";
                    setSubmitting(false);

                } catch (err) {
                    console.error("[Waitlist Error]", err);
                    if (err.message.includes("already") || err.message.includes("list")) {
                        showToast("You are already on the list! âœ¨");
                    } else {
                        showToast("Something went wrong. Try again.", true);
                    }
                    setSubmitting(false);
                }
            });
        }
    });
</script>
{% endblock %}