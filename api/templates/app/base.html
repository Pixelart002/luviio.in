{% import "macros/nav.html" as nav %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title | default('LUVIIO') }}</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/unpoly@3.10.1/unpoly.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { background: #050505; color: white; font-family: sans-serif; }
        /* Grid Background Effect */
        .bg-grid { position: fixed; inset: 0; background-image: radial-gradient(#ffffff 1px, transparent 0); background-size: 40px 40px; opacity: 0.05; pointer-events: none; z-index: -1; }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div class="bg-grid"></div>

    {{ nav.render_header(active_page | default('home')) }}

    <main id="main-content" class="flex-1 flex items-center justify-center min-h-screen px-4 select-none" up-main>
    
        {% block content %}{% endblock %}
    </main>

    <footer class="py-8 text-center text-xs text-gray-600 border-t border-white/5">
        &copy; 2026 Luviio Technologies.
    </footer>




<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    (function() {
        const SB_URL = "{{ supabase_url }}";
        const SB_KEY = "{{ supabase_key }}";
        
        // Agar keys nahi mili (e.g. error page par), toh script mat chalao
        if (!SB_URL || !SB_KEY || SB_URL === "None") return;

        const client = supabase.createClient(SB_URL, SB_KEY);

        // 1. URL CHECK: Agar Hash (#access_token) dikhe, toh screen black kar do
        if (window.location.hash && window.location.hash.includes('access_token')) {
            // Overlay banao taaki user ko "Atka hua" na feel ho
            const overlay = document.createElement('div');
            overlay.style.cssText = "position:fixed;inset:0;background:#050505;z-index:9999;display:flex;align-items:center;justify-content:center;color:#fff;font-family:sans-serif;font-size:12px;letter-spacing:2px;";
            overlay.innerHTML = `
                <div style="text-align:center;">
                    <div style="width:40px;height:40px;border:3px solid #333;border-top:3px solid #3b82f6;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px;"></div>
                    <div>FINALIZING SECURE LOGIN...</div>
                </div>
                <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>
            `;
            document.body.appendChild(overlay);
        }

        // 2. AUTH STATE CHANGE LISTENER
        client.auth.onAuthStateChange(async (event, session) => {
            // Sirf tab react karo jab Google se wapas aayein (SIGNED_IN)
            if (event === 'SIGNED_IN' && session) {
                console.log("âš¡ Global Listener: Token Captured!");
                
                // URL saaf karo
                if (window.location.hash) {
                    window.history.replaceState(null, null, window.location.pathname);
                }

                try {
                    // Backend se pucho: "Dashboard ya Onboarding?"
                    const response = await fetch('/api/auth/flow', {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ 
                            action: 'oauth_check', 
                            user_id: session.user.id,
                            user_email: session.user.email 
                        })
                    });
                    
                    const data = await response.json();
                    
                    // ðŸš€ Redirect Logic
                    if (data.next) {
                        window.location.href = "/" + data.next;
                    } else {
                        window.location.href = "/dashboard"; // Fallback
                    }
                } catch (err) {
                    console.error("Redirect Error:", err);
                    window.location.href = "/dashboard"; // Error aaya toh dashboard phek do
                }
            }
        });
    })();
</script>

</body>
</html>
</body>
</html>